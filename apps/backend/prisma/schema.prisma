generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Organisation {
  id             String        @id @default(cuid())
  name           String
  accessCode     String        @unique
  country        String?
  region         String?
  sector         String?
  size           String?
  legalStructure String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  assessments    Assessment[]
  domainGoals    DomainGoal[]
  wiseProfile    WISEProfile?
}

model DomainGoal {
  id             String       @id @default(cuid())
  organisationId String
  domainKey      String
  targetScore    Float
  targetDate     DateTime?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, domainKey])
}

model WISEProfile {
  id              String       @id @default(cuid())
  organisationId  String       @unique
  slug            String       @unique
  isPublic        Boolean      @default(false)
  bio             String?
  logoUrl         String?
  website         String?
  socialLinks     String?      // JSON
  foundingYear    Int?
  targetPopulations String?    // JSON array
  sectors         String?      // JSON array
  country         String?
  region          String?
  maturitySummary String?      // JSON: { overall, level }
  strengths       String?      // JSON array of top 3 domain names
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
}

model Assessment {
  id                   String        @id @default(cuid())
  organisationId       String
  status               String        @default("in_progress") // in_progress | completed
  overallScore         Float?
  previousAssessmentId String?
  collaborators        String?       // JSON array of collaborator assignments
  completedAt          DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  organisation         Organisation  @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  responses            Response[]
  domainScores         DomainScore[]
  sectorScores         SectorScore[]
  actionPlans          ActionPlan[]
  groupAssignments     WorkingGroupAssignment[]
}

model Response {
  id           String     @id @default(cuid())
  assessmentId String
  domainKey    String
  questionId   String
  questionType String     // likert | maturity | narrative
  numericValue Int?
  textValue    String?
  tags         String?    // JSON array stored as string
  claimedBy    String?    // Collaborator name who filled this response
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  highlights      TextHighlight[]
  researchNotes   ResearchNote[]
  quotePins       QuotePin[]
  layerHighlights LayerHighlight[]

  @@unique([assessmentId, questionId])
}

model DomainScore {
  id            String     @id @default(cuid())
  assessmentId  String
  domainKey     String
  score         Float
  maturityLevel String
  createdAt     DateTime   @default(now())
  assessment    Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, domainKey])
}

model ActionPlan {
  id             String     @id @default(cuid())
  assessmentId   String
  domainKey      String
  domainName     String
  priority       String     // high | medium | low
  recommendation String
  description    String
  effort         String     // low | medium | high
  impact         String     // low | medium | high
  timeframe      String     // short | medium | long
  currentLevel   String
  targetLevel    String
  status         String     @default("not_started") // not_started | in_progress | completed
  notes          String?
  completedAt    DateTime?
  createdAt      DateTime   @default(now())
  assessment     Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
}

model SectorScore {
  id           String     @id @default(cuid())
  assessmentId String
  sectorKey    String
  score        Float
  createdAt    DateTime   @default(now())
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, sectorKey])
}

model Benchmark {
  id               String   @id @default(cuid())
  sector           String
  sampleSize       Int
  domainAverages   String   // JSON
  domainPercentiles String  // JSON
  overallAverage   Float
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([sector])
}

model DashboardAccess {
  id         String   @id @default(cuid())
  accessCode String   @unique
  name       String
  role       String   // policymaker | funder | researcher
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  researchTags   ResearchTag[]
  highlights     TextHighlight[]
  researchNotes  ResearchNote[]
  quotePins      QuotePin[]
  codingLayers   CodingLayer[]
  sharedLayers   LayerShare[]    @relation("sharedLayers")
  codingCanvases CodingCanvas[]
}

model ResearchTag {
  id                String          @id @default(cuid())
  dashboardAccessId String
  name              String
  color             String
  description       String?
  isDefault         Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  dashboardAccess   DashboardAccess @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  highlights        TextHighlight[]
  layerHighlights   LayerHighlight[]

  @@unique([dashboardAccessId, name])
}

model TextHighlight {
  id                String          @id @default(cuid())
  dashboardAccessId String
  responseId        String
  tagId             String
  startOffset       Int
  endOffset         Int
  highlightedText   String
  createdAt         DateTime        @default(now())
  dashboardAccess   DashboardAccess @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  response          Response        @relation(fields: [responseId], references: [id], onDelete: Cascade)
  tag               ResearchTag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
}

model ResearchNote {
  id                String          @id @default(cuid())
  dashboardAccessId String
  responseId        String
  text              String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  dashboardAccess   DashboardAccess @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  response          Response        @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([dashboardAccessId, responseId])
}

model QuotePin {
  id                String          @id @default(cuid())
  dashboardAccessId String
  responseId        String
  quoteText         String
  contextNote       String?
  sortOrder         Int             @default(0)
  createdAt         DateTime        @default(now())
  dashboardAccess   DashboardAccess @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  response          Response        @relation(fields: [responseId], references: [id], onDelete: Cascade)
}

model CodingLayer {
  id                String          @id @default(cuid())
  dashboardAccessId String
  name              String
  description       String?
  isActive          Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  dashboardAccess   DashboardAccess @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  highlights        LayerHighlight[]
  shares            LayerShare[]

  @@unique([dashboardAccessId, name])
}

model LayerHighlight {
  id              String      @id @default(cuid())
  codingLayerId   String
  responseId      String
  tagId           String
  startOffset     Int
  endOffset       Int
  highlightedText String
  createdAt       DateTime    @default(now())
  codingLayer     CodingLayer @relation(fields: [codingLayerId], references: [id], onDelete: Cascade)
  response        Response    @relation(fields: [responseId], references: [id], onDelete: Cascade)
  tag             ResearchTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
}

model LayerShare {
  id             String          @id @default(cuid())
  codingLayerId  String
  sharedWithId   String
  permission     String          @default("read") // read | write
  createdAt      DateTime        @default(now())
  codingLayer    CodingLayer     @relation(fields: [codingLayerId], references: [id], onDelete: Cascade)
  sharedWith     DashboardAccess @relation("sharedLayers", fields: [sharedWithId], references: [id], onDelete: Cascade)

  @@unique([codingLayerId, sharedWithId])
}

// ─── Coding Canvas ───

model CodingCanvas {
  id                String              @id @default(cuid())
  dashboardAccessId String
  name              String
  description       String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  dashboardAccess   DashboardAccess     @relation(fields: [dashboardAccessId], references: [id], onDelete: Cascade)
  transcripts       CanvasTranscript[]
  questions         CanvasQuestion[]
  memos             CanvasMemo[]
  codings           CanvasTextCoding[]
  nodePositions     CanvasNodePosition[]
  cases             CanvasCase[]
  relations         CanvasRelation[]
  computedNodes     CanvasComputedNode[]

  @@unique([dashboardAccessId, name])
}

model CanvasTranscript {
  id        String       @id @default(cuid())
  canvasId  String
  title     String
  content   String
  sortOrder Int          @default(0)
  caseId    String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  canvas    CodingCanvas @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  case      CanvasCase?  @relation(fields: [caseId], references: [id], onDelete: SetNull)
  codings   CanvasTextCoding[]
}

model CanvasQuestion {
  id               String           @id @default(cuid())
  canvasId         String
  text             String
  color            String           @default("#3B82F6")
  sortOrder        Int              @default(0)
  parentQuestionId String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  canvas           CodingCanvas     @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  parentQuestion   CanvasQuestion?  @relation("QuestionHierarchy", fields: [parentQuestionId], references: [id], onDelete: SetNull)
  childQuestions   CanvasQuestion[] @relation("QuestionHierarchy")
  codings          CanvasTextCoding[]
}

model CanvasMemo {
  id        String   @id @default(cuid())
  canvasId  String
  title     String?
  content   String
  color     String   @default("#FEF08A")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  canvas    CodingCanvas @relation(fields: [canvasId], references: [id], onDelete: Cascade)
}

model CanvasTextCoding {
  id           String           @id @default(cuid())
  canvasId     String
  transcriptId String
  questionId   String
  startOffset  Int
  endOffset    Int
  codedText    String
  note         String?
  annotation   String?
  createdAt    DateTime         @default(now())
  canvas       CodingCanvas     @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  transcript   CanvasTranscript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)
  question     CanvasQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model CanvasNodePosition {
  id       String       @id @default(cuid())
  canvasId String
  nodeId   String
  nodeType String
  x        Float
  y        Float
  width    Float?
  height   Float?
  canvas   CodingCanvas @relation(fields: [canvasId], references: [id], onDelete: Cascade)

  @@unique([canvasId, nodeId])
}

model CanvasCase {
  id          String             @id @default(cuid())
  canvasId    String
  name        String
  attributes  String             @default("{}")
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  canvas      CodingCanvas       @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  transcripts CanvasTranscript[]

  @@unique([canvasId, name])
}

model CanvasRelation {
  id        String       @id @default(cuid())
  canvasId  String
  fromType  String
  fromId    String
  toType    String
  toId      String
  label     String
  createdAt DateTime     @default(now())
  canvas    CodingCanvas @relation(fields: [canvasId], references: [id], onDelete: Cascade)
}

model CanvasComputedNode {
  id        String       @id @default(cuid())
  canvasId  String
  nodeType  String
  label     String
  config    String       @default("{}")
  result    String       @default("{}")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  canvas    CodingCanvas @relation(fields: [canvasId], references: [id], onDelete: Cascade)
}

// ─── Phase 4A: Researcher Portal ───

model ResearcherAccount {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  institution      String
  accessLevel      String    @default("registered") // public | registered | approved
  verificationCode String?
  verified         Boolean   @default(false)
  ethicsApproval   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  dataAccessLogs   DataAccessLog[]
}

model DataAccessLog {
  id           String            @id @default(cuid())
  researcherId String
  endpoint     String
  queryParams  String?           // JSON
  resultCount  Int?
  createdAt    DateTime          @default(now())
  researcher   ResearcherAccount @relation(fields: [researcherId], references: [id], onDelete: Cascade)
}

// ─── Phase 4C: Working Group Collaboration ───

model WorkingGroup {
  id          String                 @id @default(cuid())
  name        String
  description String?
  sector      String?
  createdBy   String                 // access code of creator
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  members     WorkingGroupMember[]
  assignments WorkingGroupAssignment[]
  discussions Discussion[]
  documents   DocumentLink[]
  activities  ActivityEntry[]
}

model WorkingGroupMember {
  id             String       @id @default(cuid())
  workingGroupId String
  accessCode     String       // organisation access code
  displayName    String
  role           String       @default("member") // admin | member | observer
  joinedAt       DateTime     @default(now())
  workingGroup   WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade)

  @@unique([workingGroupId, accessCode])
}

model WorkingGroupAssignment {
  id             String       @id @default(cuid())
  workingGroupId String
  assessmentId   String
  assignedBy     String       // access code
  assignedAt     DateTime     @default(now())
  workingGroup   WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade)
  assessment     Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([workingGroupId, assessmentId])
}

model Discussion {
  id             String       @id @default(cuid())
  workingGroupId String
  authorName     String
  title          String?
  content        String
  parentId       String?      // for threaded replies
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  workingGroup   WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade)
}

model DocumentLink {
  id             String       @id @default(cuid())
  workingGroupId String
  title          String
  url            String
  description    String?
  addedBy        String       // display name
  createdAt      DateTime     @default(now())
  workingGroup   WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade)
}

model ActivityEntry {
  id             String       @id @default(cuid())
  workingGroupId String
  actorName      String
  action         String       // joined | posted | assigned | uploaded | commented
  detail         String?
  createdAt      DateTime     @default(now())
  workingGroup   WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade)
}
